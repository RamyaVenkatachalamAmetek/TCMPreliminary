/**
 **  @file HRT.c
 **  @brief High Resolution Timer
 **  @author JZJ
 **
 **/
 
/* Includes */
#include "PAL.h"

/* Macros */

/* Types */

/* Externs */

/* Function Declarations */

/* Global Variables */
/* High Resolution Ticks */
__IO HRTime_t HRTick = 0;

/* Static Variables */

/* Private Functions */

/* Public Functions */

/* Init */
void HRT_Init(void)
{
    /* Enable TIM clock */
    __HAL_RCC_TIM2_CLK_ENABLE();
    
    /* Set CR1 */
    uint32_t tmpcr1 = TIM2->CR1;  
    /* Set counter mode */
    tmpcr1 &= ~(TIM_CR1_DIR | TIM_CR1_CMS);
    tmpcr1 |= TIM_COUNTERMODE_UP;    
    /* Set the clock division */
    tmpcr1 &= ~TIM_CR1_CKD;
    tmpcr1 |= 0;    
    TIM2->CR1 = tmpcr1;
    
    /* Timebase calculation for 1 MHz - Assumed 120MHz PCLK1 */
    /* Update_event = TIM_CLK/((PSC + 1)*(ARR + 1)*(RCR + 1)) */
    
    /* Set the Autoreload value */
    TIM2->ARR = (12 - 1);
    
    /* Set the Prescaler value */
    TIM2->PSC = (10 - 1);
    
    /* Clear status register */
    TIM2->SR = 0;
    
    /* Generate an update event to reload the Prescaler
     and the repetition counter (only for advanced timer) value immediately */
    TIM2->EGR = TIM_EGR_UG;
    
    /* Enable the TIM Update interrupt */
    TIM2->DIER |= TIM_IT_UPDATE;
    
    /* Set and enable TIM_TRQn */
    PAL_NVIC_SetPriority(TIM2_IRQn, 0);
    PAL_NVIC_EnableIRQ(TIM2_IRQn);
    
    /* Enable timer */
    TIM2->CR1 |= TIM_CR1_CEN;
}

/* Increment */
void HRT_IncTick(void)
{
    HRTick++;
}

/* Get time */
HRTime_t HRT_GetTick(void)
{
    return HRTick;
}

/* Delay (usecs) */
void HRT_Delay(uint32_t Delay)
{
    HRTime_t tickStart = HRT_GetTick();
    
    /* Min 5 usec and Max 1 min of delay */
    if(Delay < 5)
        Delay = 5;
    if(Delay > (60 * 1000 * 1000))
        Delay = (60 * 1000 * 1000);
    
    while((HRT_GetTick() - tickStart) < Delay) {}
}

/* Check timeout */
bool HRT_IsTimedOut(uint32_t tickStart, uint32_t Timeout)
{
    if((HRT_GetTick() - tickStart) >= Timeout)
        return true;
    return false;
}

/* Pause timer */
void HRT_Pause(void)
{
    PAL_NVIC_DisableIRQ(TIM2_IRQn);
}

/* Resume timer */
void HRT_Resume(void)
{
    PAL_NVIC_EnableIRQ(TIM2_IRQn);
}

/******************************** End of File *********************************/
